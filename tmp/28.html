
<span style="color:#ff40ff">require</span> .digest/sha2.

<span style="color:#8080ff"># This module contains functions for hashing and storing passwords</span>
<span style="color:#ff40ff">module </span><span style="color:#00ff00">Password</span>

  <span style="color:#8080ff"># Generates a new salt and rehashes the password</span>
<span style="color:#ff40ff">  def </span><span style="color:#00ffff">Password.update</span>(password)
    salt = <span style="color:#ff6060">self</span>.salt
    hash = <span style="color:#ff6060">self</span>.hash(password,salt)
    <span style="color:#ff6060">self</span>.store(hash, salt)
  <span style="color:#ff40ff">end</span>

  <span style="color:#8080ff"># Checks the password against the stored password</span>
<span style="color:#ff40ff">  def </span><span style="color:#00ffff">Password.check</span>(password, store)
    hash = <span style="color:#ff6060">self</span>.get_hash(store)
    salt = <span style="color:#ff6060">self</span>.get_salt(store)
<span style="color:#ffff00">    if</span> <span style="color:#ff6060">self</span>.hash(password,salt) == hash
      <span style="color:#ff6060">true</span>

    <span style="color:#ffff00">else</span>
      <span style="color:#ff6060">false</span>
    <span style="color:#ffff00">end</span>
  <span style="color:#ff40ff">end</span>

  protected

  <span style="color:#8080ff"># Generates a psuedo-random 64 character string</span>

<span style="color:#ff40ff">  def </span><span style="color:#00ffff">Password.salt</span>
    salt = ..
    <span style="color:#ff6060">64</span>.times { salt &lt;&lt; (i = <span style="color:#ff40ff">Kernel</span>.rand(<span style="color:#ff6060">62</span>); i += ((i &lt; <span style="color:#ff6060">10</span>) ? <span style="color:#ff6060">48</span> : ((i &lt; <span style="color:#ff6060">36</span>) ? <span style="color:#ff6060">55</span> : <span style="color:#ff6060">61</span> ))).chr }
    salt
  <span style="color:#ff40ff">end</span>

  <span style="color:#8080ff"># Generates a 128 character hash</span>
<span style="color:#ff40ff">  def </span><span style="color:#00ffff">Password.hash</span>(password,salt)
    <span style="color:#ff40ff">Digest</span>::<span style="color:#ff40ff">SHA512</span>.hexdigest(.<span style="color:#8080ff">#{password}:#{salt}.)</span>
  <span style="color:#ff40ff">end</span>

  <span style="color:#8080ff"># Mixes the hash and salt together for storage</span>
<span style="color:#ff40ff">  def </span><span style="color:#00ffff">Password.store</span>(hash, salt)
    hash + salt
  <span style="color:#ff40ff">end</span>

  <span style="color:#8080ff"># Gets the hash from a stored password</span>
<span style="color:#ff40ff">  def </span><span style="color:#00ffff">Password.get_hash</span>(store)
    store[<span style="color:#ff6060">0</span>..<span style="color:#ff6060">127</span>]
  <span style="color:#ff40ff">end</span>

  <span style="color:#8080ff"># Gets the salt from a stored password</span>
<span style="color:#ff40ff">  def </span><span style="color:#00ffff">Password.get_salt</span>(store)
    store[<span style="color:#ff6060">128..192</span>]
  <span style="color:#ff40ff">end</span>
<span style="color:#ff40ff">end</span>
